<%# Analysis loading state with progressive stage indicators
    Accepts: card (required), stage (optional, default 0)
    Stages: 0=Validating, 1=Analyzing, 2=Processing, 3=Saving %>
<% card ||= @card %>
<% stage ||= 0 %>
<% stages = [
  { name: "Validating", message: "Validating card data..." },
  { name: "Analyzing", message: "AI is analyzing your card..." },
  { name: "Processing", message: "Processing AI response..." },
  { name: "Saving", message: "Saving analysis results..." }
] %>

<div id="card-<%= card.id %>-analysis"
     class="p-4 bg-gradient-to-br from-gray-50 to-blue-50 rounded-lg border border-gray-100"
     data-controller="loading-progress"
     data-loading-progress-current-value="<%= stage %>">

  <!-- Progress Steps -->
  <div class="flex items-center justify-between mb-4">
    <% stages.each_with_index do |s, index| %>
      <div class="flex items-center <%= 'flex-1' unless index == stages.length - 1 %>">
        <div class="flex flex-col items-center">
          <% if index < stage %>
            <!-- Completed step -->
            <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium bg-blue-500 text-white transition-all duration-300">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
            <span class="text-xs mt-1 text-blue-600 font-medium"><%= s[:name] %></span>
          <% elsif index == stage %>
            <!-- Current step -->
            <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium bg-blue-500 text-white animate-pulse transition-all duration-300">
              <svg class="w-3 h-3 animate-spin" viewBox="0 0 24 24" fill="none">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
            <span class="text-xs mt-1 text-blue-600 font-medium"><%= s[:name] %></span>
          <% else %>
            <!-- Pending step -->
            <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium bg-gray-200 text-gray-400 transition-all duration-300">
              <%= index + 1 %>
            </div>
            <span class="text-xs mt-1 text-gray-400"><%= s[:name] %></span>
          <% end %>
        </div>
        <% unless index == stages.length - 1 %>
          <div class="flex-1 h-0.5 mx-2 bg-gray-200 rounded overflow-hidden">
            <div class="h-full bg-blue-500 transition-all duration-500 ease-out"
                 style="width: <%= index < stage ? '100%' : (index == stage ? '50%' : '0%') %>"></div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Status Message -->
  <div class="flex items-center gap-2 mb-4">
    <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <span class="text-sm text-blue-600 font-medium"><%= stages[stage][:message] %></span>
  </div>

  <!-- Skeleton Content Preview -->
  <div class="space-y-3">
    <!-- Summary skeleton - more visible when analyzing -->
    <div class="space-y-2">
      <div class="h-3 bg-gray-200 rounded-full <%= stage >= 1 ? 'animate-pulse' : '' %> w-20"></div>
      <div class="h-4 bg-gray-200 rounded <%= stage >= 2 ? 'animate-pulse' : '' %> w-full"></div>
      <div class="h-4 bg-gray-200 rounded <%= stage >= 2 ? 'animate-pulse' : '' %> w-3/4"></div>
    </div>

    <!-- Metrics skeleton -->
    <div class="flex gap-4 pt-2">
      <div class="flex-1">
        <div class="h-2 bg-gray-200 rounded-full animate-pulse w-16 mb-1"></div>
        <div class="h-6 bg-gray-200 rounded <%= stage >= 2 ? 'animate-pulse' : '' %> w-12"></div>
      </div>
      <div class="flex-1">
        <div class="h-2 bg-gray-200 rounded-full animate-pulse w-14 mb-1"></div>
        <div class="h-6 bg-gray-200 rounded <%= stage >= 2 ? 'animate-pulse' : '' %> w-16"></div>
      </div>
    </div>

    <!-- Lists skeleton -->
    <div class="pt-2 space-y-2">
      <div class="h-3 bg-gray-200 rounded-full animate-pulse w-24"></div>
      <div class="space-y-1">
        <div class="h-3 bg-gray-200 rounded <%= stage >= 2 ? 'animate-pulse' : '' %> w-5/6"></div>
        <div class="h-3 bg-gray-200 rounded <%= stage >= 2 ? 'animate-pulse' : '' %> w-4/6"></div>
      </div>
    </div>
  </div>

  <!-- Cycling helpful tips -->
  <div class="mt-4 pt-3 border-t border-gray-200">
    <% tips = [
      "AI is analyzing your card content...",
      "Looking at complexity and dependencies...",
      "Identifying potential blockers...",
      "Generating actionable insights..."
    ] %>
    <p class="text-xs text-gray-400 italic" data-loading-progress-target="tip">
      <%= tips[stage] || tips.last %>
    </p>
  </div>
</div>
